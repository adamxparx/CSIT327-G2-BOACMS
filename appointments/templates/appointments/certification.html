{% extends 'accounts/dashboard.html' %}
{% load static %}

{% block title %}Certification Request Form | Barangay OACMS{% endblock %}

{% block content %}

  <div class="cert_content">
    {% block cert_content %}
    <div class="auth-wrapper">
      <div class="auth-card auth-card--wide">

        <div class="auth-header">
          <h2 class="auth-title">Book a Certificate</h2>
          <p class="auth-subtitle">Provide your appointment details below.</p>
        </div>

        {% if form.non_field_errors %}
            <div class="auth-alert auth-alert--error">
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <form method="post" class="auth-form auth-form--grid" id="appointment-form">
          {% csrf_token %}

          <div class="form-field">
            <label for="{{ form.certificate_type.id_for_label }}">{{ form.certificate_type.label }}</label>
            {{ form.certificate_type }}
            {% for error in form.certificate_type.errors %}
                <span class="field-error">{{ error }}</span>
            {% endfor %}
          </div>

          <div class="form-field" style="grid-column: span 2;">
            <label for="{{ form.purpose.id_for_label }}">{{ form.purpose.label }}</label>
            {{ form.purpose }}
            {% for error in form.purpose.errors %}
                <span class="field-error">{{ error }}</span>
            {% endfor %}
          </div>

          <div class="form-field">
            <label for="{{ form.preferred_date.id_for_label }}">{{ form.preferred_date.label }}</label>
            {{ form.preferred_date }}
            {% for error in form.preferred_date.errors %}
                <span class="field-error">{{ error }}</span>
            {% endfor %}
          </div>

          <div class="form-field">
            <label for="{{ form.preferred_time.id_for_label }}">{{ form.preferred_time.label }}</label>
            {{ form.preferred_time }}
            {% for error in form.preferred_time.errors %}
                <span class="field-error">{{ error }}</span>
            {% endfor %}
          </div>

          <div class="form-submit">
            <div class="requirements-link" style="text-align: center; margin-bottom: 15px;">
              <a href="{% url 'requirements' %}"
                 id="requirements-link"
                 data-base-url="{% url 'requirements' %}"
                 style="color: #2196F3; text-decoration: none;">
                <i class="fas fa-list"></i> See list of requirements
              </a>
            </div>
            <div class="form-action">
              <button type="submit" id="submit-button">Book Appointment</button>
            </div>
          </div>
        </form>
      </div>
    </div>

  </div>
  {% endblock %}
</div>

<script src="{% static 'appointments/js/date_restriction.js' %}"></script>
<script src="{% static 'appointments/js/time_restriction.js' %}"></script>
<script src="{% static 'appointments/js/disabled_booking_button.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('appointment-form');
    const requirementsLink = document.getElementById('requirements-link');

    if (!form || !requirementsLink) {
      return;
    }

    const baseUrl = requirementsLink.dataset.baseUrl || requirementsLink.href;
    const fieldNames = ['certificate_type', 'purpose', 'preferred_date', 'preferred_time'];

    const updateLinkHref = () => {
      const params = new URLSearchParams();

      fieldNames.forEach((name) => {
        const field = form.elements[name];
        if (!field) {
          return;
        }

        let value = '';
        if (field.type === 'select-multiple') {
          value = Array.from(field.selectedOptions).map((opt) => opt.value).join(',');
        } else if (field.type === 'checkbox' || field.type === 'radio') {
          const checked = form.querySelectorAll(`[name="${name}"]:checked`);
          if (checked.length) {
            value = Array.from(checked).map((input) => input.value).join(',');
          }
        } else {
          value = field.value;
        }

        if (value) {
          params.set(name, value);
        }
      });

      const queryString = params.toString();
      requirementsLink.href = queryString ? `${baseUrl}?${queryString}` : baseUrl;
    };

    fieldNames.forEach((name) => {
      const field = form.elements[name];
      if (!field) {
        return;
      }

      field.addEventListener('change', updateLinkHref);

      if (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA') {
        field.addEventListener('input', updateLinkHref);
      }
    });

    requirementsLink.addEventListener('click', updateLinkHref);
    updateLinkHref();
  });
</script>

{% endblock %}
