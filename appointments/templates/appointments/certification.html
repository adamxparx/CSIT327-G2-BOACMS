{% extends 'accounts/dashboard.html' %}
{% load static %}

{% block title %}Certification Request Form | Barangay OACMS{% endblock %}

{% block content %}

  <div class="cert_content">
    <link rel="stylesheet" href="{% static 'appointments/css/certification.css' %}">
    {% block cert_content %}
    <div class="auth-wrapper">
      <div class="auth-card auth-card--stacked">

        <div class="top-panel">
          <div class="auth-header">
            <h2 class="auth-title">Book a Certificate</h2>
            <p class="auth-subtitle">Provide your appointment details.</p>
          </div>
        </div>

        <div class="form-panel">
          {% if form.non_field_errors %}
              <div class="auth-alert auth-alert--error">
                  {% for error in form.non_field_errors %}
                      <p>{{ error }}</p>
                  {% endfor %}
              </div>
          {% endif %}

          <form method="post" class="auth-form auth-form--grid" id="appointment-form">
            {% csrf_token %}

            <div class="form-field">
              <label for="{{ form.certificate_type.id_for_label }}">{{ form.certificate_type.label }}</label>
              {{ form.certificate_type }}
              {% for error in form.certificate_type.errors %}
                  <span class="field-error">{{ error }}</span>
              {% endfor %}
            </div>

            <div class="form-field form-field--full">
              <label for="{{ form.purpose.id_for_label }}">{{ form.purpose.label }}</label>
              {{ form.purpose }}
              {% for error in form.purpose.errors %}
                  <span class="field-error">{{ error }}</span>
              {% endfor %}
            </div>

            <div class="form-field form-field--full" id="custom_purpose_field" style="display: none;">
              <label for="{{ form.specify_purpose.id_for_label }}">{{ form.specify_purpose.label }}</label>
              {{ form.specify_purpose }}
              {% for error in form.specify_purpose.errors %}
                  <span class="field-error">{{ error }}</span>
              {% endfor %}
            </div>

            <!-- Date and Session Selection -->
            <div class="form-field form-field--full">
              <label>Select Date and Session</label>
              <div class="date-session-container">
                <!-- Calendar -->
                <div class="calendar-container">
                  <div class="calendar-header">
                    <button type="button" class="nav-btn" id="prev-month">
                      &#8249;
                    </button>
                    <h3 id="current-month">December 2025</h3>
                    <button type="button" class="nav-btn" id="next-month">
                      &#8250;
                    </button>
                  </div>
                  <div class="calendar-grid" id="calendar-grid">
                    <!-- Calendar will be rendered here by JavaScript -->
                  </div>
                </div>

                <!-- Session Selection -->
                <div class="session-container">
                  <h3>Select Session</h3>
                  <div class="session-options">
                    <div class="session-card" data-session="am">
                      <div class="session-header">
                        <h4>AM Session</h4>
                        <i class="fas fa-check session-check"></i>
                      </div>
                      <p class="session-time">8:00 AM - 12:00 PM</p>
                      <p class="session-slots"><span id="am-slots">30</span> slots available</p>
                    </div>
                    <div class="session-card" data-session="pm">
                      <div class="session-header">
                        <h4>PM Session</h4>
                        <i class="fas fa-check session-check"></i>
                      </div>
                      <p class="session-time">1:00 PM - 5:00 PM</p>
                      <p class="session-slots"><span id="pm-slots">30</span> slots available</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Hidden fields for form submission -->
              <input type="hidden" name="preferred_date" id="selected_date" value="">
              <input type="hidden" name="preferred_time" id="selected_time" value="">
              
              <!-- Error message for date/session selection -->
              <div class="field-error" id="date-session-error" style="display: none; margin-top: 0.5rem; color: #dc2626; font-size: 0.875rem;">
                Please select both a date and session before booking.
              </div>
            </div>

            <div class="form-submit">
              <div class="requirements-link" id="requirements-link-wrap">
                <a href="{% url 'requirements' %}"
                   id="requirements-link"
                   data-base-url="{% url 'requirements' %}">
                  <i class="fas fa-list"></i> See list of requirements
                </a>
              </div>
              <div class="form-action">
                <button type="submit" id="submit-button">Book Appointment</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

  </div>
  {% endblock %}
</div>

<script src="{% static 'appointments/js/date_restriction.js' %}"></script>
<script src="{% static 'appointments/js/disabled_booking_button.js' %}"></script>
<script>
  // Calendar and Session Selection
  document.addEventListener('DOMContentLoaded', function() {
    let currentDate = new Date();
    let selectedDate = null;
    let selectedSession = null;
    
    const monthNames = ["January", "February", "March", "April", "May", "June",
                       "July", "August", "September", "October", "November", "December"];
    
    function renderCalendar(date) {
      const year = date.getFullYear();
      const month = date.getMonth();
      
      document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;
      
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const daysInPrevMonth = new Date(year, month, 0).getDate();
      
      const calendarGrid = document.getElementById('calendar-grid');
      calendarGrid.innerHTML = '';
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      // Add day headers
      const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayHeaders.forEach(day => {
        const headerDiv = document.createElement('div');
        headerDiv.className = 'calendar-day-header';
        headerDiv.textContent = day;
        calendarGrid.appendChild(headerDiv);
      });
      
      // Previous month days
      for (let i = firstDay - 1; i >= 0; i--) {
        const dateDiv = document.createElement('div');
        dateDiv.className = 'calendar-date other-month';
        dateDiv.textContent = daysInPrevMonth - i;
        calendarGrid.appendChild(dateDiv);
      }
      
      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const dateDiv = document.createElement('div');
        dateDiv.className = 'calendar-date';
        dateDiv.textContent = day;
        
        const currentDateObj = new Date(year, month, day);
        currentDateObj.setHours(0, 0, 0, 0);
        
        // Check if date is today
        if (currentDateObj.getTime() === today.getTime()) {
          dateDiv.classList.add('today');
        }
        
        // Disable past dates and today
        if (currentDateObj < today) {
          dateDiv.classList.add('disabled');
        } else {
          dateDiv.addEventListener('click', function() {
            selectDate(currentDateObj);
          });
        }
        
        // Check if this is the selected date
        if (selectedDate && currentDateObj.getTime() === selectedDate.getTime()) {
          dateDiv.classList.add('selected');
        }
        
        calendarGrid.appendChild(dateDiv);
      }
      
      // Next month days to fill the grid
      const totalCells = calendarGrid.children.length - 7; // Subtract day headers
      const remainingCells = (7 - (totalCells % 7)) % 7;
      for (let i = 1; i <= remainingCells; i++) {
        const dateDiv = document.createElement('div');
        dateDiv.className = 'calendar-date other-month';
        dateDiv.textContent = i;
        calendarGrid.appendChild(dateDiv);
      }
    }
    
    function selectDate(date) {
      selectedDate = date;
      renderCalendar(currentDate);
      updateSessionAvailability();
    }
    
    function selectSession(session) {
      selectedSession = session;
      
      document.querySelectorAll('.session-card').forEach(card => {
        card.classList.remove('selected');
      });
      
      const selectedCard = document.querySelector(`.session-card[data-session="${session}"]`);
      if (selectedCard && !selectedCard.classList.contains('disabled')) {
        selectedCard.classList.add('selected');
      }
      
      updateHiddenFields();
    }
    
    function updateSessionAvailability() {
      if (!selectedDate) {
        // Reset to default if no date selected
        document.getElementById('am-slots').textContent = '30';
        document.getElementById('pm-slots').textContent = '30';
        return;
      }
      
      // Format date as YYYY-MM-DD
      const year = selectedDate.getFullYear();
      const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
      const day = String(selectedDate.getDate()).padStart(2, '0');
      const dateStr = `${year}-${month}-${day}`;
      
      // Fetch availability from server
      fetch(`/appointments/api/date-availability/?date=${dateStr}`)
        .then(response => response.json())
        .then(data => {
          // Update slot counts
          document.getElementById('am-slots').textContent = data.am_available;
          document.getElementById('pm-slots').textContent = data.pm_available;
          
          // Disable session cards if no slots available
          const amCard = document.querySelector('.session-card[data-session="am"]');
          const pmCard = document.querySelector('.session-card[data-session="pm"]');
          
          if (data.am_available === 0) {
            amCard.classList.add('disabled');
            if (selectedSession === 'am') {
              selectedSession = null;
              amCard.classList.remove('selected');
            }
          } else {
            amCard.classList.remove('disabled');
          }
          
          if (data.pm_available === 0) {
            pmCard.classList.add('disabled');
            if (selectedSession === 'pm') {
              selectedSession = null;
              pmCard.classList.remove('selected');
            }
          } else {
            pmCard.classList.remove('disabled');
          }
        })
        .catch(error => {
          console.error('Error fetching availability:', error);
          // Fallback to default values on error
          document.getElementById('am-slots').textContent = '30';
          document.getElementById('pm-slots').textContent = '30';
        });
    }
    
    function updateHiddenFields() {
      if (selectedDate && selectedSession) {
        const year = selectedDate.getFullYear();
        const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
        const day = String(selectedDate.getDate()).padStart(2, '0');
        document.getElementById('selected_date').value = `${year}-${month}-${day}`;
        
        // Set time based on session
        if (selectedSession === 'am') {
          document.getElementById('selected_time').value = '08:00';
        } else {
          document.getElementById('selected_time').value = '13:00';
        }
        
        // Hide error message when valid selection is made
        const errorDiv = document.getElementById('date-session-error');
        if (errorDiv) {
          errorDiv.style.display = 'none';
        }
      }
    }
    
    // Event listeners
    document.getElementById('prev-month').addEventListener('click', function() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar(currentDate);
    });
    
    document.getElementById('next-month').addEventListener('click', function() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar(currentDate);
    });
    
    document.querySelectorAll('.session-card').forEach(card => {
      card.addEventListener('click', function() {
        if (!this.classList.contains('disabled') && selectedDate) {
          selectSession(this.dataset.session);
        }
      });
    });
    
    // Initial render
    renderCalendar(currentDate);
    
    // Form validation for date and session
    const appointmentForm = document.getElementById('appointment-form');
    if (appointmentForm) {
      appointmentForm.addEventListener('submit', function(e) {
        const dateValue = document.getElementById('selected_date').value;
        const timeValue = document.getElementById('selected_time').value;
        const errorDiv = document.getElementById('date-session-error');
        
        if (!dateValue || !timeValue) {
          e.preventDefault();
          errorDiv.style.display = 'block';
          // Scroll to error message
          errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          errorDiv.style.display = 'none';
        }
      });
    }
  });
  
  // Purpose field toggle
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('appointment-form');
    const requirementsLink = document.getElementById('requirements-link');
    const purposeSelect = document.getElementById('purpose_select');
    const customPurposeField = document.getElementById('custom_purpose_field');

    if (!form || !requirementsLink) {
      return;
    }

    // Function to toggle custom purpose field visibility
    const toggleCustomPurposeField = () => {
      if (purposeSelect && purposeSelect.value === 'others') {
        customPurposeField.style.display = 'block';
        const specifyPurposeInput = document.getElementById('id_specify_purpose');
        if (specifyPurposeInput) {
          specifyPurposeInput.focus();
        }
      } else {
        customPurposeField.style.display = 'none';
      }
    };

    // Handle purpose select change
    if (purposeSelect) {
      purposeSelect.addEventListener('change', toggleCustomPurposeField);
      toggleCustomPurposeField();
    }

    const baseUrl = requirementsLink.dataset.baseUrl || requirementsLink.href;
    const fieldNames = ['certificate_type', 'purpose'];

    const updateLinkHref = () => {
      const params = new URLSearchParams();

      fieldNames.forEach((name) => {
        const field = form.elements[name];
        if (!field) {
          return;
        }

        let value = '';
        if (field.type === 'select-multiple') {
          value = Array.from(field.selectedOptions).map((opt) => opt.value).join(',');
        } else if (field.type === 'checkbox' || field.type === 'radio') {
          const checked = form.querySelectorAll(`[name="${name}"]:checked`);
          if (checked.length) {
            value = Array.from(checked).map((input) => input.value).join(',');
          }
        } else {
          value = field.value;
        }

        if (value) {
          params.set(name, value);
        }
      });

      const queryString = params.toString();
      requirementsLink.href = queryString ? `${baseUrl}?${queryString}` : baseUrl;
    };

    fieldNames.forEach((name) => {
      const field = form.elements[name];
      if (!field) {
        return;
      }

      field.addEventListener('change', updateLinkHref);

      if (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA') {
        field.addEventListener('input', updateLinkHref);
      }
    });

    requirementsLink.addEventListener('click', updateLinkHref);
    updateLinkHref();
  });
</script>

{% endblock %}
