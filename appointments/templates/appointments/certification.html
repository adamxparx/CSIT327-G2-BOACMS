{% extends 'accounts/dashboard.html' %}
{% load static %}

{% block title %}Certification Request Form | Barangay OACMS{% endblock %}

{% block content %}

  <div class="cert_content">
    <link rel="stylesheet" href="{% static 'appointments/css/certification.css' %}">
    {% block cert_content %}
    <div class="auth-wrapper">
      <div class="auth-card auth-card--wide">

        <div class="left-panel">
          <div class="auth-header">
            <h2 class="auth-title">Book a Certificate</h2>
            <p class="auth-subtitle">Provide your appointment details.</p>
          </div>
        </div>

        <div class="form-panel">
          {% if form.non_field_errors %}
              <div class="auth-alert auth-alert--error">
                  {% for error in form.non_field_errors %}
                      <p>{{ error }}</p>
                  {% endfor %}
              </div>
          {% endif %}

          {% if recommended_slot %}
              <div class="auth-alert auth-alert--info recommended-slot-alert">
                  <p>
                      The selected slot is no longer available. Nearest available slot:
                      <strong>{{ recommended_slot.date|date:"F j, Y" }}</strong>
                      at
                      <strong>{{ recommended_slot.time|time:"g:i A" }}</strong>.
                  </p>
                  <button type="button"
                          id="apply-recommended-slot"
                          class="btn"
                          data-slot-date="{{ recommended_slot.date|date:"Y-m-d" }}"
                          data-slot-time="{{ recommended_slot.time|time:"H:i" }}">
                      Use this slot
                  </button>
              </div>
          {% endif %}

          <form method="post" class="auth-form auth-form--grid" id="appointment-form">
            {% csrf_token %}

            <div class="form-field">
              <label for="{{ form.certificate_type.id_for_label }}">{{ form.certificate_type.label }}</label>
              {{ form.certificate_type }}
              {% for error in form.certificate_type.errors %}
                  <span class="field-error">{{ error }}</span>
              {% endfor %}
            </div>

            <div class="form-field form-field--full">
              <label for="{{ form.purpose.id_for_label }}">{{ form.purpose.label }}</label>
              {{ form.purpose }}
              {% for error in form.purpose.errors %}
                  <span class="field-error">{{ error }}</span>
              {% endfor %}
            </div>

            <div class="form-field form-field--full" id="custom_purpose_field" style="display: none;">
              <label for="{{ form.specify_purpose.id_for_label }}">{{ form.specify_purpose.label }}</label>
              {{ form.specify_purpose }}
              {% for error in form.specify_purpose.errors %}
                  <span class="field-error">{{ error }}</span>
              {% endfor %}
            </div>

            <div class="form-field">
              <label for="{{ form.preferred_date.id_for_label }}">{{ form.preferred_date.label }}</label>
              {{ form.preferred_date }}
              {% for error in form.preferred_date.errors %}
                  <span class="field-error">{{ error }}</span>
              {% endfor %}
            </div>

            <div class="form-field">
              <label for="{{ form.preferred_time.id_for_label }}">{{ form.preferred_time.label }}</label>
              {{ form.preferred_time }}
              {% for error in form.preferred_time.errors %}
                  <span class="field-error">{{ error }}</span>
              {% endfor %}
            </div>

            <div class="form-submit">
              <div class="requirements-link" id="requirements-link-wrap">
                <a href="{% url 'requirements' %}"
                   id="requirements-link"
                   data-base-url="{% url 'requirements' %}">
                  <i class="fas fa-list"></i> See list of requirements
                </a>
              </div>
              <div class="form-action">
                <button type="submit" id="submit-button">Book Appointment</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

  </div>
  {% endblock %}
</div>

<script src="{% static 'appointments/js/date_restriction.js' %}"></script>
<script src="{% static 'appointments/js/time_restriction.js' %}"></script>
<script src="{% static 'appointments/js/disabled_booking_button.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('appointment-form');
    const requirementsLink = document.getElementById('requirements-link');
    const applyRecommendedButton = document.getElementById('apply-recommended-slot');
    const purposeSelect = document.getElementById('purpose_select');
    const customPurposeField = document.getElementById('custom_purpose_field');

    if (!form || !requirementsLink) {
      return;
    }

    // Function to toggle custom purpose field visibility
    const toggleCustomPurposeField = () => {
      if (purposeSelect && purposeSelect.value === 'others') {
        customPurposeField.style.display = 'block';
        const specifyPurposeInput = document.getElementById('id_specify_purpose');
        if (specifyPurposeInput) {
          specifyPurposeInput.focus();
        }
      } else {
        customPurposeField.style.display = 'none';
      }
    };

    // Handle purpose select change
    if (purposeSelect) {
      purposeSelect.addEventListener('change', toggleCustomPurposeField);
      toggleCustomPurposeField();
    }

    const baseUrl = requirementsLink.dataset.baseUrl || requirementsLink.href;
    const fieldNames = ['certificate_type', 'purpose', 'preferred_date', 'preferred_time'];

    const updateLinkHref = () => {
      const params = new URLSearchParams();

      fieldNames.forEach((name) => {
        const field = form.elements[name];
        if (!field) {
          return;
        }

        let value = '';
        if (field.type === 'select-multiple') {
          value = Array.from(field.selectedOptions).map((opt) => opt.value).join(',');
        } else if (field.type === 'checkbox' || field.type === 'radio') {
          const checked = form.querySelectorAll(`[name="${name}"]:checked`);
          if (checked.length) {
            value = Array.from(checked).map((input) => input.value).join(',');
          }
        } else {
          value = field.value;
        }

        if (value) {
          params.set(name, value);
        }
      });

      const queryString = params.toString();
      requirementsLink.href = queryString ? `${baseUrl}?${queryString}` : baseUrl;
    };

    fieldNames.forEach((name) => {
      const field = form.elements[name];
      if (!field) {
        return;
      }

      field.addEventListener('change', updateLinkHref);

      if (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA') {
        field.addEventListener('input', updateLinkHref);
      }
    });

    requirementsLink.addEventListener('click', updateLinkHref);
    updateLinkHref();

    if (applyRecommendedButton) {
      applyRecommendedButton.addEventListener('click', () => {
        const dateField = form.elements['preferred_date'];
        const timeField = form.elements['preferred_time'];

        if (dateField) {
          dateField.value = applyRecommendedButton.dataset.slotDate || '';
          dateField.dispatchEvent(new Event('change'));
        }

        if (timeField) {
          timeField.value = applyRecommendedButton.dataset.slotTime || '';
          timeField.dispatchEvent(new Event('change'));
          timeField.classList.remove('highlight-success');
          // Force reflow to restart animation if applied multiple times
          void timeField.offsetWidth;
          timeField.classList.add('highlight-success');
        }

        const errorAlert = document.querySelector('.auth-alert--error');
        if (errorAlert) {
          errorAlert.classList.add('is-hidden');
        }

        const fieldErrors = form.querySelectorAll('.field-error');
        fieldErrors.forEach((error) => {
          error.classList.add('is-hidden');
        });

        const recommendedAlert = document.querySelector('.recommended-slot-alert');
        if (recommendedAlert) {
          recommendedAlert.classList.add('is-hidden');
        }

        updateLinkHref();
      });
    }
  });
</script>

{% endblock %}
