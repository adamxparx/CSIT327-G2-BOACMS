{% extends 'accounts/dashboard.html' %}
{% load static %}

{% block title %}Appointments{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'appointments/css/appointments.css' %}">
<link rel="stylesheet" href="{% static 'appointments/css/alerts.css' %}">

<div class="appointments-center">
{% if appointments %}
    <div class="appointments-card">
        {% if claimed_count %}
        <div class="message_success">You have {{ claimed_count }} claimed appointments. Click <b style="color: blue; text-decoration: underline;"><a href="{% url 'claimed_appointments' %}">here</a></b> to confirm your claimed appointments.</div>
        {% endif %}
        <div class="header">
            <div>
                <h2 class="title">Your Appointments</h2>
                <div class="subtitle">Manage your upcoming bookings below</div>
            </div>
            <div>
                <div>
                    <a href="{% url 'claimed_appointments' %}">
                        <button class="status-button status-button--complete">
                            Completed Appointments
                        </button>
                    </a>
                </div>
            </div>
        </div>

        <table class="appts-table">
            <thead>
                <tr>
                    <th style="width:22%">Date &amp; Time</th>
                    <th style="width:28%">Certificate</th>
                    <th style="width:22%">Purpose</th>
                    <th style="width:14%">Status</th>
                    <th style="width:14%;text-align:center;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for appointment in appointments %}
                {% if appointment.status != 'completed' and appointment.status != 'claimed' %}
                    <tr data-href="{% url 'appointment_detail' appointment.id %}" style="cursor: pointer;">
                        <td class="date-cell">
                            <span class="date-main">{{ appointment.preferred_date|date:"M. j, Y" }}</span>
                            <span class="date-time">{{ appointment.preferred_time|time:"g:i a" }}</span>
                        </td>
                        <td>{{ appointment.get_certificate_type_display }}</td>
                        <td>
                          {% if appointment.purpose == 'others' %}
                            {{ appointment.get_purpose_display }}: {{ appointment.specify_purpose }}
                          {% else %}
                            {{ appointment.get_purpose_display }}
                          {% endif %}
                        </td>
                        <td style="vertical-align:middle;">
                            {% if appointment.status == 'approved' %}
                                <span class="status-badge badge-approved">Approved</span>
                            {% elif appointment.status == 'cancelled' %}
                                <span class="status-badge badge-cancelled">Cancelled</span>
                            {% elif appointment.status == 'pending' %}
                                <span class="status-badge badge-pending">Pending</span>
                            {% endif %}
                            
                            <!-- Show reschedule indicator -->
                            {% if appointment.rescheduled_at %}
                                <br><span class="status-badge badge-rescheduled">Rescheduled</span>
                            {% endif %}
                        </td>
                        <td style="text-align:center;">
                            {% if appointment.status == 'approved' or appointment.status == 'pending' %}
                                <a href="{% url 'cancel_appointment' appointment.id %}" role="button" aria-label="Cancel appointment {{ appointment.id }}" data-appointment-id="{{ appointment.id }}" class="btn-cancel" onclick="event.stopPropagation();">Cancel</a>
                            {% else %}
                                <span class="btn-none">‚Äî</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div style="width:100%;max-width:800px;display:flex;justify-content:center;">
        <div style="text-align:center;background:#fbfdff;border:1px solid #e6eef8;padding:28px;border-radius:12px;box-shadow:0 6px 20px rgba(14,30,45,0.04);width:100%;">
            <div style="font-size:48px;line-height:1;margin-bottom:12px;">üóìÔ∏è</div>
            <h3 style="margin:0 0 8px 0;color:#0f1724">No upcoming appointments</h3>
            <p style="color:#5b6b77;margin:0 0 14px 0">You currently have no scheduled bookings. When you book an appointment, it will appear here.</p>
        </div>
    </div>
{% endif %}
</div>

<!-- Modal for appointment details -->
<div id="appointmentModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modalBody"></div>
    </div>
</div>

<style>
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        border-radius: 12px;
        width: 80%;
        max-width: 800px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        position: relative;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        position: absolute;
        right: 20px;
        top: 10px;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
    }

    @media (max-width: 768px) {
        .modal-content {
            width: 95%;
            margin: 10% auto;
            padding: 15px;
        }
    }
</style>

<script>
    // Make table rows clickable to show appointment details in modal
    document.addEventListener('DOMContentLoaded', function() {
        const rows = document.querySelectorAll('tbody tr[data-href]');
        const modal = document.getElementById("appointmentModal");
        const span = document.getElementsByClassName("close")[0];
        const modalBody = document.getElementById("modalBody");
        
        rows.forEach(row => {
            row.addEventListener('click', function(e) {
                // Prevent opening modal when clicking on the cancel button
                if (e.target.closest('.btn-cancel')) {
                    return;
                }
                
                // Fetch appointment details and show in modal
                const url = this.dataset.href;
                fetchAppointmentDetails(url);
            });
        });
        
        // Close the modal when the user clicks on X
        span.onclick = function() {
            modal.style.display = "none";
            modalBody.innerHTML = "";
        }
        
        // Close the modal when the user clicks anywhere outside of the modal content
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
                modalBody.innerHTML = "";
            }
        }
        
        // Function to fetch appointment details and populate modal
        function fetchAppointmentDetails(url) {
            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.text())
                .then(html => {
                    modalBody.innerHTML = html;
                    modal.style.display = "block";
                })
                .catch(error => {
                    console.error('Error fetching appointment details:', error);
                });
        }
    });
    
    // Confirmation for cancel links
    (function(){
        document.addEventListener('click', function(e){
            var el = e.target.closest && e.target.closest('a.btn');
            if(!el) return;
            if(el.classList.contains('disabled-link')){
                e.preventDefault();
                return;
            }
            var id = el.getAttribute('data-appointment-id') || '';
            var confirmMessage = 'Are you sure you want to cancel this appointment' + (id ? (' (ID: ' + id + ')') : '') + '?';
            if(!confirm(confirmMessage)){
                e.preventDefault();
            }
        }, false);
    })();
</script>

{% endblock %}