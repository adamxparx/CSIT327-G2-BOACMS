{% extends dashboard_template %}
{% block content %}

<h2>Appointments Calendar</h2>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
#calendar-container {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
}

.nbi-slot-box {
    margin-top: 6px;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.nbi-slot {
    background: #1da1d8;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 6px 4px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
}

.nbi-slot small {
    font-size: 0.65rem;
    font-weight: normal;
}

.nbi-slot:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.fc-daygrid-day-number {
    font-weight: bold;
}
</style>

<div id="calendar-container">
    <div id="calendar"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const calendarEl = document.getElementById("calendar");
    let availability = {};

    fetch("{% url 'api_month_availability' %}")
        .then(res => res.json())
        .then(data => {
            data.forEach(d => availability[d.date] = d);
            initCalendar();
        });

    function initCalendar() {
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            height: "auto",

            hiddenDays: [0], // hide Sunday

            dayCellDidMount(info) {
                const dateStr = info.date.toISOString().split("T")[0];
                const data = availability[dateStr] || { am: 0, pm: 0 };

                const frame = info.el.querySelector(".fc-daygrid-day-frame");

                frame.insertAdjacentHTML("beforeend", `
                    <div class="nbi-slot-box">
                        <button class="nbi-slot"
                            ${data.am === 0 ? "disabled" : ""}
                            onclick="selectSlot('${dateStr}','AM')">
                            AM<br><small>${data.am} Slots</small>
                        </button>

                        <button class="nbi-slot"
                            ${data.pm === 0 ? "disabled" : ""}
                            onclick="selectSlot('${dateStr}','PM')">
                            PM<br><small>${data.pm} Slots</small>
                        </button>
                    </div>
                `);
            }

        });


        calendar.render();
    }

    window.selectSlot = function(date, period) {
        alert(`Selected ${period} on ${date}`);
        // redirect to booking form here
    };
});
</script>

{% endblock %}
